<template>
  <v-container fluid class="login-screen" fill-height>
    <v-row no-gutters justify="center" align-content="center">
      <img
        :width="400"
        src="@/assets/taranis-logo-login.svg"
        alt="taranis logo"
      />
    </v-row>
    <v-form id="form" ref="form" @submit.prevent="authenticate">
      <v-row no-gutters justify="center" align-content="center">
        <v-col cols="3">
          <v-text-field
            v-model="username"
            :placeholder="$t('login.username')"
            name="username"
            prepend-icon="person"
            type="text"
            :rules="[acceptUser]"
            autocomplete="username"
            required
          />
        </v-col>
        <v-col cols="3">
          <v-text-field
            v-model="password"
            :placeholder="$t('login.password')"
            name="password"
            prepend-icon="lock"
            type="password"
            :rules="[acceptPassword]"
            autocomplete="password"
            required
          />
        </v-col>
        <v-col cols="1">
          <v-btn
            icon="mdi-login-variant"
            type="submit"
            color="primary"
            :disabled="loginButtonDisabled"
            @click="authenticate"
          />
        </v-col>
      </v-row>
    </v-form>
    <v-alert v-if="login_error !== undefined" dense type="error" text>{{
      $t(login_error)
    }}</v-alert>
  </v-container>
</template>

<script>
import { useAuthStore } from '@/stores/AuthStore'
import { useSettingsStore } from '@/stores/SettingsStore'
import { defineComponent, ref, computed, inject } from 'vue'
import { useRouter } from 'vue-router'

export default defineComponent({
  name: 'LoginView',

  setup() {
    const username = ref('')
    const password = ref('')
    const login_error = ref(undefined)
    const coreAPIURL = inject('$coreAPIURL')
    const router = useRouter()
    console.debug('coreAPIURL', coreAPIURL)

    const acceptPassword = computed(() => password.value.length > 0)
    const acceptUser = computed(() => username.value.length > 0)
    const loginButtonDisabled = computed(
      () => !acceptPassword.value || !acceptUser.value
    )

    const { isAuthenticated, login } = useAuthStore()
    const { loadUserProfile } = useSettingsStore()

    const authenticate = () => {
      login({ username: username.value, password: password.value }).then(
        (error) => {
          if (isAuthenticated.value) {
            login_error.value = undefined
            loadUserProfile()
            router.push('/')
          }
          if (error) {
            if (error.status > 500) {
              login_error.value = 'login.backend_error'
            } else {
              login_error.value = 'login.error'
            }
          }
        }
      )
    }

    return {
      username,
      password,
      login_error,
      acceptPassword,
      acceptUser,
      loginButtonDisabled,
      authenticate
    }
  }
})
</script>
