<template>
  <v-container
    v-bind="UI.CARD.CONTAINER"
    class="card-item"
    data-type="report-item"
  >
    <v-row no-gutters>
      <v-col v-if="multiSelectActive" :style="UI.STYLE.card_selector_zone">
        <v-row justify="center" align="center">
          <v-checkbox
            v-if="!preselected"
            v-model="selected"
            @change="selectionChanged"
          ></v-checkbox>
        </v-row>
      </v-col>

      <v-col :class="UI.CLASS.card_offset">
        <v-hover v-slot="{ hover }">
          <v-card
            v-bind="UI.CARD.HOVER"
            :elevation="hover ? 12 : 2"
            @click.stop="cardItemToolbar"
            :color="selectedColor"
          >
            <!--CONTENT-->
            <v-layout v-bind="UI.CARD.LAYOUT" :class="'status ' + itemStatus">
              <v-row v-bind="UI.CARD.ROW.CONTENT">
                <v-col :style="UI.STYLE.card_tag">
                  <v-icon center>{{ card.tag }}</v-icon>
                </v-col>
                <v-col>
                  <div class="grey--text">{{ $t('card_item.title') }}</div>
                  <span>{{ card.title }}</span>
                </v-col>
                <v-col>
                  <div class="grey--text">{{ $t('card_item.created') }}</div>
                  <span>{{ card.created }}</span>
                </v-col>
                <v-col :style="UI.STYLE.card_hover_toolbar">
                  <!--HOVER TOOLBAR-->
                  <div v-if="hover">
                    <v-row
                      v-if="!multiSelectActive && !publish_selector"
                      v-bind="UI.CARD.TOOLBAR.COMPACT"
                      :style="UI.STYLE.card_toolbar"
                    >
                      <v-col v-bind="UI.CARD.COL.TOOLS">
                        <v-btn
                          icon
                          class="red"
                          @click.stop="cardItemToolbar('delete')"
                          :title="$t('analyze.tooltip.delete_item')"
                        >
                          <v-icon color="white">mdi-trash-can-outline</v-icon>
                        </v-btn>
                        <v-btn
                          icon
                          @click.stop="cardItemToolbar('new')"
                          :title="$t('analyze.tooltip.publish_item')"
                        >
                          <v-icon color="info">mdi-file-outline</v-icon>
                        </v-btn>
                      </v-col>
                    </v-row>
                    <v-row
                      v-if="publish_selector"
                      v-bind="UI.CARD.TOOLBAR.COMPACT"
                      :style="UI.STYLE.card_toolbar"
                    >
                      <v-col v-bind="UI.CARD.COL.TOOLS">
                        <v-btn icon @click.stop="cardItemToolbar('remove')">
                          <v-icon color="accent"
                            >mdi-minus-circle-outline</v-icon
                          >
                        </v-btn>
                      </v-col>
                    </v-row>
                  </div>
                </v-col>
              </v-row>
            </v-layout>
          </v-card>
        </v-hover>
      </v-col>
    </v-row>
  </v-container>
</template>

<script>
import AuthMixin from '@/services/auth/auth_mixin'
import { analyzeStore } from '@/stores/AnalyzeStore'
import { mapActions } from 'pinia'
import { mapState } from 'vuex'

export default {
  name: 'CardAnalyze',
  props: {
    card: Object,
    publish_selector: Boolean,
    preselected: Boolean
  },
  mixins: [AuthMixin],
  data: () => ({
    toolbar: false,
    selected: false,
    status: 'in_progress'
  }),
  computed: {
    ...mapState(analyzeStore, ['multi_select_report']),
    multiSelectActive() {
      return this.multi_select_report
    },

    selectedColor() {
      if (this.selected === true || this.preselected) {
        return 'orange lighten-4'
      }
      return ''
    },
    itemStatus() {
      return this.card.completed ? 'completed' : 'in_progress'
    }
  },
  methods: {
    ...mapActions(analyzeStore, [
      'addSelectionReport',
      'removeSelectionReport'
    ]),
    selectionChanged() {
      if (this.selected === true) {
        this.addSelectionReport({
          id: this.card.id,
          item: this.card
        })
      } else {
        this.removeSelectionReport({
          id: this.card.id,
          item: this.card
        })
      }
    },

    itemClicked(data) {
      if (data.remote_user === null) {
        this.$emit('show-report-item-detail', data)
      } else {
        this.$emit('show-remote-report-item-detail', data)
      }
    },
    deleteClicked(data) {
      this.$root.$emit('delete-report-item', data)
    },
    cardItemToolbar(action) {
      switch (action) {
        case 'delete':
          this.deleteClicked(this.card)
          break

        case 'new':
          this.$root.$emit('new-product', [this.card])
          break

        case 'remove':
          this.$emit('remove-report-item-from-selector', this.card)
          break

        default:
          this.toolbar = false
          this.itemClicked(this.card)
          break
      }
    },

    multiSelectOff() {
      this.selected = false
    }
  },
  mounted() {
    this.$root.$on('multi-select-off', this.multiSelectOff)
  },
  beforeDestroy() {
    this.$root.$off('multi-select-off', this.multiSelectOff)
  }
}
</script>
